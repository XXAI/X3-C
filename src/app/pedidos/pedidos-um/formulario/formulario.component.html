<!-- crud asignar url de la api URL="url de la api" titulo="un titulo para la pestaña de la pagina" [dato]="variable que contiene el formulario]-->
<!-- <formulario #ctrl URL="entrada-almacen" titulo="DAM / Apertura pedido" [dato]="dato"></formulario> -->

<!-- Menu principal  menutitulo="titulo del modulo en el que estamos con el nombre como se encuentra en enviroment" menuactual="nombre del hub donde estamos como se especifico en el routing"-->
<div style="height: 50px">
    <app-menu-dam [modulo]="'Pedido UM'" [icono]="'assets/hub-estandar.svg'" [url]="'/pedidos/UM'" [urlAyuda]="'ayuda'"></app-menu-dam>
</div>

<div class="contenedor columns " style="padding: 1em;">
    <div class="column is-one-quarter">
        <section class="hero is-primary" style="border-top-left-radius: 1em; border-top-right-radius: 1em;">
            <h1 class="title" style="margin:0.5em; ">
                <span class="icon is-medium">
                    <i class="fa fa-file-text"></i>
                </span> Datos generales
            </h1>
        </section>
        <div style="background: #FFF; padding: 1em; overflow: scroll; overflow-x: hidden;"> 
                <!-- <i class="fa fa-file"></i>
                    Datos del movimiento -->
                    <div class="columns" style="font-size: 22px; text-align: right">
                        <strong class="column">Presupuesto Total: </strong>
                        <strong class="column">{{ ( this.form_dato.metadato_compra_consolidada?.presupuesto_compra | currency:'' ) }}  &nbsp;  &nbsp;  </strong>
                    </div>
                    <span class="help is-danger" *ngIf="error_formulario">El presupuesto total no puede ser $0.00.</span>
                    <div>
                            <div class="field">
                                <label class="label">Presupuesto Causes:</label>
                                <p class="control is-expanded  has-icon has-icon-right" style="text-align: right;" *ngIf="form_dato.metadato_compra_consolidada != null" >
                                    {{ this.form_dato.metadato_compra_consolidada.presupuesto_causes ? (this.form_dato.metadato_compra_consolidada.presupuesto_causes | currency:'') : ( 0 | currency:'')}}
                                    <!-- <input class="input"  currencyMask [(ngModel)]='form_dato.metadato_compra_consolidada.presupuesto_causes' 
                                        [options]="{ prefix: '$ ', thousands: ',', decimal: '.' }"
                                        (keypress)="validar_input_currency('presupuesto_causes'); calcular_presupuesto_asignado()"
                                        (blur)="validar_input_currency('presupuesto_causes'); calcular_presupuesto_asignado()"/> -->
                                </p>
                            </div>
                            <div class="field">
                                <label class="label">Presupuesto No Causes:</label>
                                <p class="control is-expanded  has-icon has-icon-right" style="text-align: right;" *ngIf="form_dato.metadato_compra_consolidada != null">
                                        {{ this.form_dato.metadato_compra_consolidada.presupuesto_no_causes ? (this.form_dato.metadato_compra_consolidada.presupuesto_no_causes | currency:'') : ( 0 | currency:'')}}
                                    <!-- <input class="input"  currencyMask [(ngModel)]='form_dato.metadato_compra_consolidada.presupuesto_no_causes' 
                                        [options]="{ prefix: '$ ', thousands: ',', decimal: '.' }"
                                        (keypress)="validar_input_currency('presupuesto_no_causes'); calcular_presupuesto_asignado()"
                                        (blur)="validar_input_currency('presupuesto_no_causes'); calcular_presupuesto_asignado()"/> -->
                                </p>
                            </div>
                    </div>
        </div>
        <div style="background: #FFF; padding: 1em; overflow: scroll; overflow-x: hidden;" [style.height.px]="tamano-420"> 
            <div>
                <div class="field">
                    <label class="label">Fecha límite de captura:</label>
                    <p class="control is-expanded  has-icon has-icon-right">
                        <input class="input"  [(ngModel)]='form_dato.metadato_compra_consolidada.fecha_limite_captura' ngui-datetime-picker 
                            [min-date]="capturaDate" date-only="true"
                            [ngClass]="{'is-disabled': form_dato.estatus === 'FI', 'is-danger': form_dato.fecha_inicio == ''}" name="fecha_inicio"
                            placeholder="YYYY-MM-DD" readonly/>

                        <span class="icon is-small">
                            <i class="fa fa-warning" *ngIf="form_dato.metadato_compra_consolidada.fecha_limite_captura == ''"></i>
                        </span>
                        <span class="help is-danger" *ngIf="form_dato.metadato_compra_consolidada.fecha_limite_captura == ''">Este campo es requerido.</span>
                    </p>
                </div>
                <div class="control" >
                    <div class="field">
                        <label class="label">Programa:</label>
                    </div><!-- SI carga los programas -->
                    <div class="control is-grouped">
                        <span *ngIf="cargando || cargandoCatalogo" class="tag is-primary is-medium">Cargando programas. 
                            <i class="fa fa-refresh fa-spin" aria-hidden="true"></i>
                        </span>
                        <div  *ngIf="!cargando && !cargandoCatalogo" class="select control is-expanded  has-icon has-icon-right">
                            <select class="select is-medium" name="seleccionar_programa" id="seleccionar_programa" required
                                [(ngModel)]='form_dato.metadato_compra_consolidada.programa_id'
                                [ngClass]="{'is-disabled': tieneid && form_dato.estatus == 'FI'}">
                                <option value="">Seleccione un programa</option>
                                <option *ngFor="let item of lista_programas" value="{{item.id}}">{{ item.nombre }}</option>
                            </select>
                            <span class="icon is-small" *ngIf="form_dato.metadato_compra_consolidada.programa_id == 0 && error_formulario">
                                <i class="fa fa-warning"></i>
                            </span>
                            <span class="help is-danger" *ngIf="form_dato.metadato_compra_consolidada.programa_id == 0 && error_formulario">Este campo es requerido.</span>
                            <span class="help is-danger" *ngIf="lista_programas.length == 0"> No se cargaron programas, contacte al administrador.</span>
                        </div>
                    </div>
                </div>
                <br>
                <div class="field">
                    <label class="label">Observaciones:</label>
                    <p class="control is-expanded  has-icon has-icon-right">
                        <textarea class="textarea" type="text"
                            [ngClass]="{'is-disabled': form_dato.estatus === 'CONCLUIDO'}"
                            placeholder="Observaciones" [(ngModel)]='form_dato.observaciones' ></textarea>
                    </p>
                </div>                
            </div>
        </div>
    </div>
    <div class="column" style="padding:1em;">
            <!-- inicio formulario -->
            <div style="background: #FFF; border-radius: 1em;">
                <div style="border-radius: 1em;">
                    <section class="hero is-primary" style="border-top-left-radius: 1em; border-top-right-radius: 1em;">
                        <div class="title" style="margin:0.5em;">
                            <!-- Opciones  -->
                            <nav class="level" style="padding-left: 1em;">
                                <!-- Left side -->
                                <div class="level-left ">
                                    <div class="level-item">
                                        <p class="title">
                                            <span *ngIf="!cargando || !cargando" class="icon is-medium">
                                                <i class="fa fa-list-alt"></i>
                                            </span>
                                            <span *ngIf="cargando || cargando" class="icon is-medium">
                                                <i class="fa fa-refresh fa-spin"></i>
                                            </span>
                                            Presupuestos
                                        </p>
                                    </div>
                                </div>
                            
                                <div class="level-right">
                                    <button class="button is-primary tooltip"  routerLink="/pedidos/dam">
                                        <span class="icon fa-2x">
                                            <i class="fa fa-arrow-left"> </i>
                                        </span>
                                        <span class="tooltiptext">Regresar</span>
                                    </button>

                                    <button class="button is-primary tooltip" (click)=" cargarCatalogo('programa', 'lista_programas', 'estatus'); cargarDatos(form_dato.id);" id='cargar_datos_actualizar'>
                                        <span class="icon ">
                                            <i class="fa fa-refresh fa-2x"></i>
                                        </span>
                                        <span class="tooltiptext">Actualizar</span>
                                    </button>
                                    <button class="button is-primary" type="button" [ngClass]="{'is-loading': cargando, 'is-hidden': form_dato.estatus === 'FI'}" (click)="enviar();">
                                        <span class="icon">
                                            <i class="fa fa-floppy-o" aria-hidden="true"></i>
                                        </span> &nbsp; Guardar avance
                                        <span id="borrador" (click)="enviar();"></span>
                                    </button>
    
                                    <button class="button is-primary tooltip" (click)="crearApertura()" type="submit" [ngClass]="{'is-loading': cargando, 'is-hidden': form_dato.estatus === 'FI'}" [disabled]="form_dato.invalid">
                                        <span class="icon" style="color: darkgreen">
                                            <i class="fa fa-unlock-alt fa-2x"> </i>
                                        </span>
                                        <span class="tooltiptext" style="color: darkgreen">Crear apertura</span>
                                    </button>
                                    
                                    <button class="button is-primary tooltip" (click)="concentrar_pedido();" title="Concentrar pedido Global" type="submit"
                                            [ngClass]="{'is-loading': cargando, 'is-hidden': form_dato.estatus === 'BR'}"
                                            [disabled]="form_dato.estatus == 'BR'">
                                        <span class="icon" style="color: blue">
                                            <i class="fa fa-play-circle fa-2x"></i>
                                        </span>
                                        <span class="tooltiptext" style="color: blue">Concentrar pedido global</span>
                                    </button>
                                    <button class="button is-primary tooltip"  (click)="imprimir()" title="PDF" type="submit"
                                        [ngClass]="{'is-loading': cargando}" [disabled]="form_dato.invalid">
                                        <!-- , 'is-hidden': form_dato.estatus === 'BR' -->
                                        <span class="icon">
                                            <i class="fa fa-file-pdf-o fa-2x"></i>
                                        </span>
                                        <span class="tooltiptext">Imprimir</span>
                                    </button>
                                </div>
                            </nav>
                        </div>
                    </section>
                    <div>
                            <div style="padding: 1em;padding-right: 3.5em;padding-left: 2em;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Presupuesto</th>
                                            <th style="text-align: right; width: 33%">CAUSES</th>
                                            <th style="text-align: right; width: 33%">NO CAUSES</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr >
                                            <th>Autorizado</th>
                                            <th style="text-align: right; width: 33%"> {{(form_dato.metadato_compra_consolidada.presupuesto_causes | currency:'' ) }} </th>
                                            <th style="text-align: right; width: 33%"> {{(form_dato.metadato_compra_consolidada.presupuesto_no_causes | currency:'' )}}</th>
                                        </tr>
                                        <tr>
                                            <th>Asignado</th>
                                            <td style="text-align: right; width: 33%">
                                                <span [ngStyle]="{'color': form_dato.metadato_compra_consolidada.presupuesto_causes_asignado > form_dato.metadato_compra_consolidada.presupuesto_causes ? 'red' : ''}">
                                                    {{(form_dato.metadato_compra_consolidada.presupuesto_causes_asignado | currency:'' )}}
                                                </span>
                                            </td>
                                            <td style="text-align: right; width: 33%"> 
                                                <span [ngStyle]="{'color': form_dato.metadato_compra_consolidada.presupuesto_no_causes_asignado > form_dato.metadato_compra_consolidada.presupuesto_no_causes ? 'red' : ''}">
                                                    {{(form_dato.metadato_compra_consolidada.presupuesto_no_causes_asignado | currency:'' )}}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Disponible</th>
                                            <td style="text-align: right; width: 33%"> <span [ngStyle]="{'color': form_dato.metadato_compra_consolidada.presupuesto_causes_disponible < 0 ? 'red' : ''}">{{(form_dato.metadato_compra_consolidada.presupuesto_causes_disponible | currency:'' )}} </span></td>
                                            <td style="text-align: right; width: 33%">
                                                <span [ngStyle]="{'color': form_dato.metadato_compra_consolidada.presupuesto_no_causes_disponible < 0 ? 'red' : ''}">
                                                    {{(form_dato.metadato_compra_consolidada.presupuesto_no_causes_disponible | currency:'' )}}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                                
                            <!-- Botón para agregar programas  -->
                            <article class="tile is-primary is-child notification has-text-centered" style="padding: 0; padding-left: 1em;">
                                <nav class="level" style="padding-left: 1em;">
                                    <!-- Left side -->
                                    <div class="level-left" style="margin: 0.5em">
                                        <div class="level-item">
                                            <p class="title">
                                                <span *ngIf="!cargando || !cargando" class="icon is-medium">
                                                    <i class="fa fa-shopping-basket"></i>
                                                </span>
                                                <span *ngIf="cargando || cargando" class="icon is-medium">
                                                    <i class="fa fa-refresh fa-spin"></i>
                                                </span>
                                                Insumos
                                            </p>
                                        </div>
                                    </div>
                                    <div class="level-right" style="padding-right: 4em;">
                                            <div class="field" style="width: 50em">
                                                <div class="control">
                                                    <input ngui-auto-complete
                                                        id="buscarInsumo"
                                                        name="buscarInsumo"
                                                        #buscarInsumo
                                                        autofocus="false"
                                                        [source]="lista_insumos"
                                                        [list-formatter]="autocompleListFormatInsumo"
                                                        display-property-name="descripcion"
                                                        path-to-data=""
                                                        loading-text="Cargando..."
                                                        no-match-found-text="No hay resultados."
                                                        (valueChanged)="select_insumo_autocomplete($event)"
                                                        min-chars="1"
                                                        class="input"
                                                        value-property-name="insumo_datos.insumo_medico_clave"
                                                        [ngClass]="{'is-hidden': tieneid && form_dato.estatus == 'FI'}"
                                                        type="text" placeholder="Ingrese clave o descripcion del insumo">
                                                </div>
                                            </div>
                                        <!-- <div class="level-item" [ngClass]="{'is-hidden': form_dato.estatus == 'FI'}">
                                            <a  class="button is-primary"
                                                [ngClass]="{'is-hidden': form_dato.estatus === 'FI' }"
                                                title="Agregar más insumos de esta clave" (click)="agregarInsumo()"> 
                                                <span class="icon"><i class="fa fa-plus-circle" aria-hidden="true"></i></span>&nbsp; Agregar insumos 
                                            </a>
                                        </div> -->
                                    </div>
                                </nav>
                            </article>
                            <div  style="padding: 1em; overflow: scroll; overflow-x: hidden;" [style.height.px]="tamano-400">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th style=" text-align: center;"><abbr title="#">NP</abbr></th>
                                            <th style=" text-align: center;">Clave</th>
                                            <th>Descripción</th>
                                            <th style=" text-align: center;">Precio</th>
                                            <th style=" text-align: center;">Cantidad</th>
                                            <th style=" text-align: center;">Importe</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let insumo of form_dato.insumos; let i_insumos = index">
                                            <th style=" text-align: center;">{{i_insumos + 1}} </th>
                                            <th style=" text-align: center;"><span>{{insumo.insumo_medico_clave}}&nbsp;</span></th>
                                            <th>
                                                <span>{{insumo.descripcion}}&nbsp;</span>
                                            </th>
                                            <th style="text-align: right;">
                                                {{insumo.precio_unitario | currency:''}}
                                            </th>
                                            <th style=" text-align: right;">
                                                <input class="input is-small" [(ngModel)]="insumo.cantidad" style="text-align: right" [ngModelOptions]="{standalone: true}"
                                                    [textMask]="{mask:numberMask}"
                                                    (keypress)="quitar_punto($event);"
                                                    (keyup)="cambio_cantidad_stock_key($event, form_dato.insumos[i_insumos], i_insumos)"
                                                    (blur)="cambio_cantidad_stock_key($event, form_dato.insumos[i_insumos], i_insumos)"
                                                    (change)="cambio_cantidad_stock_key($event, form_dato.insumos[i_insumos], i_insumos)"                                                    
                                                    [ngClass]="{'is-danger': form_dato.insumos[i_insumos].cantidad == '' || form_dato.insumos[i_insumos].existencia == null || form_dato.insumos[i_insumos].cantidad < 1, 'is-disabled': form_dato.estatus === 'FI'}">
                                                    <!-- 
                                                        (keyup)="cambio_cantidad_stock_key($event, form_dato.insumos[i_insumos], i_insumos)"
                                                    (blur)="cambio_cantidad_stock_key($event, form_dato.insumos[i_insumos], i_insumos)"
                                                    (change)="cambio_cantidad_stock_key($event, form_dato.insumos[i_insumos], i_insumos)"
                                                        -->
                                            </th>
                                            <th style=" text-align: center;">
                                                {{insumo.importe | currency:''}}
                                            </th>
                                        </tr>
                                        <tr *ngIf="form_dato.insumos.length == 0">
                                            <td colspan="6" style="vertical-align: middle; color:#888;">Esta lista está vacía.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                    </div>                    
                </div>
            </div>
            <simple-notifications [options]="options"></simple-notifications>
    </div>
</div>

<!-- ***************************************** INICIO - MODALES ***************************************** -->


<div [ngClass]="{'is-active': cargarPedido}" class="modal" id="cargandoInventario" >
    <div class="modal-background"></div>
    <div class="modal-content">
        <p style="color: rgb(255, 255, 255); text-align: center;">
            <span><i class="fa fa-spinner fa-pulse fa-10x"></i></span>
            <br>
            <span><h1>Cargando pedido. <strong style="color: #FFF">Espere un momento.</strong> </h1></span>
        </p>
    </div>
</div>

<div class="modal" id="confirmarReestablecer">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
        <p class="modal-card-title"><i class="fa fa-warning"></i> Alerta</p>
        <button class="delete" (click)="cancelarModal('confirmarReestablecer')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <h1>¿Esta seguro de resetear el inventario?</h1>
                <p>esta acción cargaratodos los productos que tienen inventario para susutituirlo, es necesario llenar y guardar la inicialización de inventario para que se refleje en el stock</p>
            </div>
        </section>
        <footer class="modal-card-foot">
        <a class="button is-success" (click)="cargarArticulos('iniciar')" >Continuar</a>
        <a class="button" (click)="cancelarModal('confirmarReestablecer')" id="cerra_restablecer">Cancelar</a>
        </footer>
    </div>
</div>
<div class="modal" id="borrarInsumo">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title"><i class="fa fa-warning"></i> Alerta</p>
            <button class="delete" (click)="cancelarModal('borrarInsumo')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <h1>¿Esta seguro de eliminar el insumo?</h1>
                <p>Se borrarán todos los lotes del insumo que se hayan agregado.</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <a class="button is-success" (click)="quitar_form_array(form_dato.programas[i_programa].insumos, index_insumo); cancelarModal('borrarInsumo');">Continuar</a>
            <a class="button" (click)="cancelarModal('borrarInsumo')">Cancelar</a>
        </footer>
    </div>
</div>

<div class="modal" id="borrarCLUES">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title"><i class="fa fa-warning"></i> Alerta</p>
            <button class="delete" (click)="cancelarModal('borrarCLUES')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <h1>¿Esta seguro de eliminar la CLUES seleleccionada?</h1>
                <p>Se borrarán todos el lote seleccionado.</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <a class="button is-success" (click)="quitar_form_array(form_dato.insumos, index_borrar); cancelarModal('borrarCLUES');">Continuar</a>
            <a class="button" (click)="cancelarModal('borrarCLUES')">Cancelar</a>
        </footer>
    </div>
</div>

<div class="modal" id="detalleCLUES">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 80%">
        <header class="modal-card-head">
            <p class="modal-card-title"><i class="fa fa-warning"></i> CLUES CSSSA017370 - ALMACÉN JURISDICCIONAL (PICHUCALCO)</p>
            <button class="delete" (click)="cancelarModal('detalleCLUES')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <h1>¿Esta seguro de eliminar el lote?</h1>
                <p>Se borrarán todos el lote seleccionado.</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <a class="button is-success">Continuar</a>
            <a class="button" (click)="cancelarModal('detalleCLUES')">Cancelar</a>
        </footer>
    </div>
</div>
