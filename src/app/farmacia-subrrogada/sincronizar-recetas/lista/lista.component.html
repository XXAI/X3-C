<formulario #ctrl URL="sincronizar-recetas" titulo="Sincronizar receta" [dato]="dato"></formulario>
<menu-farmacia [modulo]="'Sincronizar recetas'" [icono]="'assets/hub-farmacia-sub.svg'" [url]="'/farmacia-subrrogada/sincronizar-recetas'"></menu-farmacia>
<div style="height:50px;"></div>
<div class="contenedor columns " style="height:100%; ">
    
    <div class="column" style="padding:2em;">
        <div style="background: #FFF; border-radius: 1em; overflow: hidden;">
            <section class="hero" [ngClass]=" {'is-dark': ctrl.busquedaActivada, 'is-primary': !ctrl.busquedaActivada } ">

                <div class="hero-body" style="position:relative;">
                    <a class="button  is-dark" *ngIf="ctrl.busquedaActivada" style="position:absolute; top:1em; right:1em;" (click)="ctrl.busquedaActivada=false;searchBox.value=''; ctrl.resultadosBusqueda=[]"><span class="icon "><i class="fa fa-close"></i></span></a>
                    <a class="button  is-dark" *ngIf="ctrl.busquedaActivada" style="position:absolute; top:1em; right:3.5em;" (click)="ctrl.listarBusqueda(searchBox.value,1)"><span class="icon "><i class="fa fa-refresh"></i></span></a>
                    <a class="button  is-primary" *ngIf="!ctrl.busquedaActivada" style="position:absolute; top:1em; right:1em;" (click)="ctrl.listar(1)"><span class="icon "><i class="fa fa-refresh"></i></span></a>
                    <div class="container is-fluid">

                        <div class="is-hidden-desktop">
                            <h1 class="title" *ngIf="!ctrl.busquedaActivada">
                                <span class="icon is-medium"><i class="fa fa-user"></i></span> Salidas por recetas
                            </h1>
                        </div>
                        <div class="is-hidden-touch">
                            <div style="height:30px;"></div>
                        </div>
                        <h1 class="title" *ngIf="ctrl.busquedaActivada">
                            <span class="icon is-medium"><i class="fa fa-search"></i></span> Búsqueda
                        </h1>
                        <div class="control is-grouped">
                            <p class="control is-expanded">
                                <input class="input is-medium" type="text" placeholder="Buscar" #searchBox id="search-box" (keyup)="ctrl.buscar(searchBox.value)">
                            </p>
                            <!-- <p class="control">
                                <a class="button is-medium is-primary is-inverted " routerLink="/farmacia-subrrogada/sincronizar-recetas/nuevo">
                                    <span class="icon"><i class="fa fa-plus"></i></span><span>Nuevo</span>
                                </a>
                            </p> -->
                        </div>
                    </div>
                </div>
            </section>
            <div class="is-fullwidth has-text-centered" *ngIf="ctrl.cargando">
                <br>
                <span class="tag is-primary is-large "><span class="icon"><i class="fa fa-refresh fa-spin"></i></span> &nbsp;<span>Cargando...</span></span>
                <br>
                <br>
            </div>

            <table class="table" *ngIf="!cargando" style="min-width:100%; font-size:1em;">
                <thead>
                    <tr>
                        <th></th>
                        <th style="text-align:center;"></th>
                        <th colspan="2" style="text-align:center;">Aceptados</th>
                        <th class="causes" colspan="2" style="text-align:center;">Ignorados</th>
                        <th></th>
                    </tr>
                    <tr>
                        <th>Folio/Nombre del Pedido/Unidad Medica</th>
                        <th style="text-align:center;">Fecha</th>
                        
                        <th class="aceptados" style="text-align:center;">Recetas</th>
                        <th class="aceptados" style="text-align:center;">Colectivos</th>

                        <th class="ignorados" style="text-align:center;">Recetas</th>
                        <th class="ignorados" style="text-align:center;">Colectivos</th>

                        <th style="text-align:center;">Opciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="vertical-align: middle;">
                            <strong>CSSSA018740-2017-PA-003</strong>
                            <br>H. B. C. DR. RAFAEL ALFARO GONZÁLEZ PIJIJIAPAN<br>
                            solicitud de pedido
                        </td>
                        <td style="text-align:center; vertical-align: middle;">
                            2017-05-26<br>
                        </td>
                        <td class="aceptados" style="text-align:center; vertical-align: middle;">3</td>
                        <td class="aceptados" style="text-align:center; vertical-align: middle;" >10</td>
                        <td class="ignorados" style="text-align:center; vertical-align: middle;" >2</td>
                        <td class="ignorados" style="text-align:center; vertical-align: middle;" >0</td>
                        <td style="text-align:center; vertical-align: middle;">
                            <button type="button" class="button" (click)="abrirModal('sincronizarRecetasJson')" >
                                <span class="icon"><i class="fa fa-upload"></i></span>
                                <i class="fa fa-file-code-o" aria-hidden="true"></i>
                            </button>
                            <button type="button" class="button" (click)="abrirModal('sincronizarRecetasImagenes')" >
                                <span class="icon"><i class="fa fa-upload"></i></span>
                                <i class="fa fa-file-image-o" aria-hidden="true"></i>
                            </button>
                        </td>
                    </tr>
                    <!--
                    <tr *ngFor="let item of lista; let i=index"> 
                        
                        <td style="vertical-align: middle;">
                            <strong>{{ item.folio }}</strong>
                            <br>{{item.unidad_medica}}
                            <br>{{item.descripcion}}
                        </td>
                        
                        <td style="text-align:center; vertical-align: middle;" [ngClass]="{'estatus-rojo':(item.status != 'EF' && item.expira_en_dias <= 0),'estatus-amarillo':(item.status == 'PS' && (item.expira_en_dias > 0 && item.expira_en_dias <= 5))}">
                            {{ item.fecha_concluido | date:'y-MM-dd' }}<br>
                            <span *ngIf="item.status != 'EF'">
                                [{{ item.fecha_expiracion | date:'y-MM-dd' }}]<br>
                            </span>
                            <strong *ngIf="item.status == 'PS' && item.expira_en_dias >= 0">
                                Expira <span *ngIf="item.expira_en_dias == 0">Hoy</span><span *ngIf="item.expira_en_dias > 0">en {{item.expira_en_dias}} día(s)</span>
                            </strong>
                            <strong *ngIf="item.status == 'EX' && item.expira_en_dias < 0">
                                <span *ngIf="item.status != 'EX-CA'">Expirado  hace {{item.expira_en_dias*(-1)}} día(s)</span>
                            </strong>
                        </td>
                        
                        <td style="text-align:center; vertical-align: middle; white-space: nowrap;">{{ item.total_claves_recibidas }} / {{ item.total_claves_solicitadas }} <br> <strong>({{(item.total_claves_recibidas/item.total_claves_solicitadas)*100 | number:'1.0-2'}} %)</strong></td>
                        <td style="text-align:center; vertical-align: middle;">$ {{ item.total_monto_recibido | number:'1.2-2' }} / $ {{ item.total_monto_solicitado | number:'1.2-2' }} <br> <strong>({{((item.total_monto_recibido/item.total_monto_solicitado)*100) | number:'1.0-2'}} %)</strong></td>

                        <td class="causes"  style="text-align:center; vertical-align: middle; white-space: nowrap;">
                            <span *ngIf="item.total_claves_causes">{{ item.total_claves_causes_recibidas }} / {{ item.total_claves_causes }} <br> <strong>({{((item.total_claves_causes_recibidas/item.total_claves_causes)*100) | number:'1.0-2'}} %)</strong></span>
                            <span *ngIf="!item.total_claves_causes"> </span>
                        </td>
                        <td class="causes"  style="text-align:center; vertical-align: middle;">
                            <span *ngIf="(+item.total_monto_causes*1)">${{ item.total_monto_causes_recibido  | number:'1.2-2'}} / ${{ item.total_monto_causes  | number:'1.2-2'}} <br> <strong>({{((item.total_monto_causes_recibido/item.total_monto_causes)*100) | number:'1.0-2'}} %)</strong></span>
                            <span *ngIf="!(+item.total_monto_causes*1)">  </span>
                        </td>

                        <td style="text-align:center; vertical-align: middle; width: 130px">
                            <button type="button" class="button"  (click)="mostrarDialogoPedidos(item.pedido_id)" >
                                <span class="icon is-small"><i class="fa fa-archive"></i></span>
                            </button>
                            
                            <button type="button" class="button" [ngClass]="{'descargado':item.repositorio>0 }" (click)="mostrarDialogoArchivos(item.pedido_id, item.folio)" >
                                <span class="icon is-small"><i class="fa fa-upload"></i></span><span class="tag" [ngClass]="{'color_tag_descargas':item.repositorio>0 }"><b>{{ item.repositorio }}</b></span>
                            </button>
                        </td>
                    </tr> 
                    <tr *ngIf="lista.length == 0">
                        <td colspan="12" style="vertical-align: middle; color:#888;">Esta lista está vacía.</td>                    
                    </tr>-->
                </tbody>
            </table>

            <!-- Paginación para la lista  -->
            <paginacion [total]="ctrl.total" [paginasTotales]="ctrl.paginasTotales" [resultadosPorPagina]="ctrl.resultadosPorPagina"
                [paginaActual]="ctrl.paginaActual" [indicePaginas]="ctrl.indicePaginas" (onSiguiente)="ctrl.paginaSiguiente()"
                (onAnterior)="ctrl.paginaAnterior()" (onListar)="ctrl.listar($event)" *ngIf="ctrl.total>0 && ctrl.total > ctrl.resultadosPorPagina && !ctrl.busquedaActivada"></paginacion>
            <!-- Paginación para la búsqueda  -->
            <paginacion [total]="ctrl.totalBusqueda" [paginasTotales]="ctrl.paginasTotalesBusqueda" [resultadosPorPagina]="ctrl.resultadosPorPaginaBusqueda"
                [paginaActual]="ctrl.paginaActualBusqueda" [indicePaginas]="ctrl.indicePaginasBusqueda" (onSiguiente)="ctrl.paginaSiguienteBusqueda(searchBox.value)"
                (onAnterior)="ctrl.paginaAnteriorBusqueda(searchBox.value)" (onListar)="ctrl.listarBusqueda(searchBox.value,$event)"
                *ngIf="ctrl.totalBusqueda > 0 && ctrl.totalBusqueda > ctrl.resultadosPorPaginaBusqueda && ctrl.busquedaActivada"></paginacion>
        </div>
    </div>
</div>

<div class="modal" id="sincronizarRecetasJson">
    <div class="modal-background"></div>
    <div class="modal-card"  style="width:80%; height: 75%; overflow: hidden;">
        <header class="modal-card-head" style="background: #00d1b2;">
                <div class="container is-fluid"  style="width:100%;">
                    <h1 class="title" style="color:#FFF;">
                        <span class="icon is-medium"><i class="fa fa-file-code-o"></i></span> 
                        Sincronizar recetas JSON
                    </h1>
                </div>     
            <button class="delete" (click)="cancelarModal('sincronizarRecetasJson')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <form name="form" novalidate [formGroup]="dato" (ngSubmit)="ctrl.enviar()" #mainScreen>
                    <!-- Recetas JSON -->
                    <div class="column">
                        <div style="background: #FFF; border-radius: 1em; ">
                            <div class="is-fullwidth has-text-centered" *ngIf="!ctrl.datosCargados">
                                <br>
                                <span class="tag is-primary is-large "><span class="icon"><i class="fa fa-refresh fa-spin"></i></span>                    &nbsp;<span>Cargando...</span></span>
                            </div>
                            <section class="section" [style.height.px]="tamano">

                                <div class="is-half">
                                    <div class="field has-addons">
                                        <label class="label">Archivo JSON:</label>
                                        <div style="height:20px;"></div>
                                        <p class="control is-expanded  has-icon has-icon-right" style="float:left; width: 95.1%;" >
                                            <input class="input" type="file" (change)="ctrl.convertirJson($event, ctrl.dato.controls.json)" accept=".json, .txt">
                                            <input type="hidden" formControlName="json">
                                        </p>
                                        <p class="control" style="float:left">
                                            <button class="button is-primary" type="submit" [ngClass]="{'is-loading': ctrl.cargando, 'is-disabled':ctrl.dato.controls.json.value == ''}" [disabled]="ctrl.error_json">Enviar</button>
                                        </p>
                                    </div>
                                    
                                </div>
                                <figure class="highlight" style="width: 100%; height: 300px; overflow: auto;">
                                    <pre>
                                        <span class="help is-danger" *ngIf="ctrl.error_json">El archivo no es valido o no tiene el formato adecuado.</span>
                                        <code class="language-json" data-lang="json">{{ ctrl.dato.controls.json.value | json }}</code>
                                    </pre>                        
                                </figure>
                                <div class="box">
                                    <span>Recetas aceptadas:</span> <span class="tag is-success">2</span>
                                    &nbsp;&nbsp;&nbsp;<span>Colectivos aceptados:</span> <span class="tag is-success">2</span>
                                    &nbsp;&nbsp;&nbsp;<span>Recetas ignoradas:</span> <span class="tag is-danger">2</span>
                                    &nbsp;&nbsp;&nbsp;<span>Colectivos ignorados:</span> <span class="tag is-danger">0</span>
                                </div>
                                
                            </section>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        <footer class="modal-card-foot">
            <a class="button is-success" [ngClass]="{'is-disabled':1==1}" (click)="agregarLoteIsumo(cantidad_solicitada.value)">Sincronizar recetas</a>
            <a class="button" (click)="cancelarModal('sincronizarRecetasJson')">Cancelar</a>
        </footer>
    </div>
</div>

<div class="modal" id="sincronizarRecetasImagenes">
    <div class="modal-background"></div>
    <div class="modal-card"  style="width:80%; height: 75%; overflow: hidden;">
         <header class="modal-card-head" style="background: #00d1b2;">
                <div class="container is-fluid"  style="width:100%;">
                    <h1 class="title" style="color:#FFF;">
                        <span class="icon is-medium"><i class="fa fa-file-image-o" aria-hidden="true"></i></span> 
                        Sincronizar recetas (Fotos)
                    </h1>
                </div>     
            <button class="delete" (click)="cancelarModal('sincronizarRecetasImagenes')"></button>
        </header>
        <section class="modal-card-body">
            <form name="form" novalidate [formGroup]="dato" (ngSubmit)="ctrl.enviar()" #mainScreen>
                <!-- Recetas JSON -->
                <div class="column">
                    <div style="background: #FFF; border-radius: 1em; ">
                        <div class="is-fullwidth has-text-centered" *ngIf="!ctrl.datosCargados">
                            <br>
                            <span class="tag is-primary is-large "><span class="icon"><i class="fa fa-refresh fa-spin"></i></span>                    &nbsp;<span>Cargando...</span></span>
                        </div>
                        <section class="section" [style.height.px]="tamano">

                            <div class="is-half">
                                <div class="field has-addons">
                                    <label class="label">Imagen Receta:</label>
                                    <div style="height:20px;"></div>
                                    <p class="control is-expanded  has-icon has-icon-right" style="float:left; width: 95.1%;" >
                                        <input class="input" type="file" multiple (change)="ctrl.seleccionarImagenBase64($event, ctrl.dato.controls.archivos, true)" accept=".jpeg, .jpg, .gif, .bmp, .png">
                                        <input type="hidden" formControlName="archivos">
                                    </p>
                                    <p class="control" style="float:left">
                                        <button class="button is-primary" type="submit" [ngClass]="{'is-loading': ctrl.cargando}" [disabled]="ctrl.dato.controls.archivos.value == ''">Enviar</button>
                                    </p>
                                </div>
                                
                            </div>
                            <figure class="highlight" style="width: 100%; height: 300px; overflow: auto;">
                                <div *ngFor="let item of ctrl.dato.controls.archivos.value; let i=index">
                                    <img  [src]="'data:image/png;base64,' + item" 
                                    width="10%" style="float:left; border-style: dashed; border-radius: 5px;" (click)="abrirModal('verFoto', item)">
                                </div>                        
                            </figure>
                            
                        </section>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <a class="button is-success" (click)="agregarLoteIsumo(cantidad_solicitada.value)">Continuar</a>
            <a class="button" (click)="cancelarModal('sincronizarRecetasImagenes')">Cancelar</a>
        </footer>
    </div>
</div>