<menu-farmacia></menu-farmacia>

<div style="height:50px;"></div>
<div class="contenedor columns " style="height:100%; padding:1em;">
    <div class="column is-one-third" >
      <div style="background: #FFF; border-radius: 1em; overflow: hidden;">
            <section class="hero is-primary" >
              <h1 class="title" style="margin:0.5em; " ><span class="icon is-medium"><i class="fa fa-file-text"></i></span> Nuevo pedido</h1>
              
            </section>
            
            <div style="padding: 1em;">
              <label class="label">Solicitar a:</label>
              <p class="control">
                <span class="select is-fullwidth">
                  <select>
                    <option>Farmacia Exfarma</option>
                    <option>Almacén general</option>
                  </select>
                </span>
              </p>
              
              <div class="control">
                <textarea class="textarea" placeholder="Observaciones"></textarea>
              </div>
              <div class="control is-grouped">
                <p class="control">
                  <button class="button is-primary" type="submit" [ngClass]="{'is-loading': cargando}" >Guardar</button>
                </p>
                <p class="control">
                  <a class="button is-white" routerLink="/farmacia/pedidos/" >Ir a la lista</a>
                </p>
              </div>
            </div>
        </div>
        <br>
        
    </div>
    <div class="column" >
        <div class="tabs  is-boxed" style="margin-bottom:0px; " *ngIf="pedidos.length > 1" >
          <ul>
            <li *ngFor="let pedido of pedidos; let i = index" [ngClass]="{ 'is-active': i == pedidoActivo}"><a (click)="pedidoActivo = i">{{ pedido.nombre}}</a></li>
          </ul>
        </div>
        <div *ngFor="let pedido of pedidos; let indexPedido = index" class="contenedor-pedido" [ngClass]="{ 'con-tabs' : pedidos.length > 1 }" [hidden]="indexPedido != pedidoActivo">
          
          <div class="top-bar" [ngClass]="{'is-primary':!pedido.filtro.activo && pedidos.length == 1,'is-dark': pedido.filtro.activo }">
            <span *ngIf="!pedido.filtro.activo">Claves: {{ pedido.lista.length }} Insumos: 0</span>
            <span *ngIf="pedido.filtro.activo"><span class="icon"><i class="fa fa-search"></i></span> Resultados: {{ pedido.filtro.lista.length }}</span>
            <a class="button is-primary  is-pulled-right" [ngClass]="{ 'is-inverted': pedidos.length == 1 || pedido.filtro.activo }" style="margin-top:-0.25em;" title="Ctrl + espacio" (click)="toggleModalInsumos(); ">
              <span class="icon"><i class="fa fa-plus"></i></span><span>Agregar</span>
            </a>
          </div> 
          
          <table class="table is-unselectable" *ngIf="!cargando" style="font-size: 0.8em;">
              <thead>
                  <tr >
                    <th style="width:41px;vertical-align: middle;" class="has-text-centered" >Lote</th>
                    <th style="width:118px;">
                      <p class="control is-expanded" >
                        <input type="hidden" #searchBoxClavePrevia >
                        <input class="input is-small" type="text" placeholder="Clave" #searchBoxClave id="search-box-clave-{{indexPedido}}" (keyup)="buscar($event,searchBoxClave, searchBoxClavePrevia,[{ input: searchBoxDescripcion, campos: ['generico','concentracion','presentacion']}, { input: searchBoxClave, campos: ['clave']}])">
                      </p>
                    </th>
                    <th>
                      <p class="control is-expanded">
                        <input type="hidden" #searchBoxDescripcionPrevia >
                        <input class="input is-small" type="text" placeholder="Genérico" #searchBoxDescripcion id="search-box-descripcion-{{indexPedido}}" (keyup)="buscar($event,searchBoxDescripcion,searchBoxDescripcionPrevia,[{ input: searchBoxDescripcion, campos: ['generico','concentracion','presentacion']}, { input: searchBoxClave, campos: ['clave']}])">
                      </p>
                    </th>                    
                    <th style="text-align: center; vertical-align: middle;"><abbr title="Cantidad">Cant.</abbr></th>
                    <th></th>
                  </tr>
              </thead>
              <tbody *ngIf="!pedido.filtro.activo">
                <tr *ngFor="let item of pedido.paginacion.lista; let i = index;">
                  <td class="has-text-centered">{{ item.lote }}</td>
                  <th class="has-text-centered"><a (click)="mostrarFichaInformativa(item.clave)" style="cursor:help;">{{ item.clave }}</a></th>
                  <td >
                    <b>{{ item.generico }}</b> <small><b>{{ item.concentracion }}</b></small><br>
                    <i>{{ item.presentacion }}</i> <span *ngIf="item.controlado" class="tag is-warning" style="font-size: 0.7em">Controlado</span> <span *ngIf="!item.causes" class="tag is-info" style="font-size: 0.7em">No causes</span><br>
                    <small>{{ item.descripcion }}</small>
                  </td>
                  <th>
                      <p class="control is-expanded">
                      <input class="input is-small has-text-centered"  type="text" placeholder="Cant" [(ngModel)]="item.cantidad">
                      </p>
                  </th>                  
                  <td><a (click)="pedido.eliminarItem(item,i)"><span class="icon"><i class="fa fa-trash"></i></span></a></td>
                </tr>                
              </tbody>
              <tbody *ngIf="pedido.filtro.activo">
                <tr *ngFor="let item of pedido.filtro.paginacion.lista; let i = index;">
                  <td class="has-text-centered">{{ item.lote }}</td>
                  <th class="has-text-centered"><a (click)="mostrarFichaInformativa(item.clave)" style="cursor:help;">{{ item.clave }}</a></th>
                  <td>
                    <b>{{ item.generico }}</b> <small><b>{{ item.concentracion }}</b></small><br>
                    <i>{{ item.presentacion }}</i> <span *ngIf="item.controlado" class="tag is-warning" style="font-size: 0.7em">Controlado</span> <span *ngIf="!item.causes" class="tag is-info" style="font-size: 0.7em">No causes</span><br>
                    <small>{{ item.descripcion }}</small>
                  </td>
                  <th>
                      <p class="control is-expanded">
                      <input class="input is-small has-text-centered"  type="text" placeholder="Cant" [(ngModel)]="item.cantidad">
                      </p>
                  </th>                  
                  <td><a (click)="pedido.filtro.eliminarItem(item,i)"><span class="icon"><i class="fa fa-trash"></i></span></a></td>
                </tr>
              </tbody>              
          </table>
         
          <paginacion 
                [total]="pedido.lista.length" 
                [paginasTotales]="pedido.paginacion.totalPaginas" 
                [resultadosPorPagina]="pedido.paginacion.resultadosPorPagina" 
                [paginaActual]="pedido.paginacion.paginaActual" 
                [indicePaginas]="pedido.paginacion.indice"
                (onSiguiente)="pedido.paginaSiguiente()" 
                (onAnterior)="pedido.paginaAnterior()" 
                (onListar)="pedido.listar($event)" 
                *ngIf="pedido.lista.length > 0 && pedido.lista.length > pedido.paginacion.resultadosPorPagina && !pedido.filtro.activo"></paginacion>
          
          <paginacion 
                [total]="pedido.filtro.lista.length" 
                [paginasTotales]="pedido.filtro.paginacion.totalPaginas" 
                [resultadosPorPagina]="pedido.filtro.paginacion.resultadosPorPagina" 
                [paginaActual]="pedido.filtro.paginacion.paginaActual" 
                [indicePaginas]="pedido.filtro.paginacion.indice"
                (onSiguiente)="pedido.filtro.paginaSiguiente()" 
                (onAnterior)="pedido.filtro.paginaAnterior()" 
                (onListar)="pedido.filtro.listar($event)" 
                *ngIf="pedido.filtro.lista.length > 0 && pedido.filtro.lista.length > pedido.filtro.paginacion.resultadosPorPagina && pedido.filtro.activo"></paginacion>
          
          <br>
        </div>
        
    </div>
</div>

<div class="notification is-danger" style="position:fixed; left:1em;  bottom:1em;" *ngIf="mensajeError.mostrar">
    <button class="delete" (click)="mensajeError.mostrar = false"></button>        
    <b>Error:</b> {{ mensajeError.texto }}<br><br>
    <p style="text-align:center" ><a  class="button is-danger is-inverted" (click)="ultimaPeticion(); mensajeError.mostrar = false"> <span class="icon"><i class="fa fa-refresh"></i></span> <span>Volver a intentar</span></a></p>        
</div>

<div class="notification is-success" style="position:fixed; left:1em;  bottom:1em; width: auto" *ngIf="mensajeExito.mostrar">       
    <button class="delete" (click)="mensajeExito.mostrar = false"></button>
    <p><span class="icon" style="margin-right: 0.5em;"><i class="fa fa-check-circle"></i></span> <span>{{ mensajeExito.texto }}</span></p>
    <br>
    <p style="text-align: center;"><small >Este mensaje desaparecerá en {{ mensajeExito.cuentaAtras }} segundos.</small></p>       
</div>

<buscar-insumos *ngIf="mostrarModalInsumos" (onCerrar)="mostrarModalInsumos = false" (onEnviar)="agregarItem($event)"></buscar-insumos>

